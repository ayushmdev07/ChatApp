@{
    ViewData["Title"] = "Home Page";
}


<style>
    body {
        font-family: 'Inter', sans-serif;
    }

    ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
    }

    .fontwa {
        font-family: "Yuji Boku", serif;
        font-weight: 400;
        font-style: normal;
    }

    li{
        text-decoration:none;
    }

    .split-btn {
  display: flex;
  width: 100%; 
  border: none;
  border-radius: 50px; 
  overflow: hidden;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}

.split-btn:hover { transform: translateY(-2px); }

.sb-text {
  flex: 1; 
  padding: 12px;
  color: white;
  font-weight: 600;
  background: linear-gradient(90deg, #ff409a, #c4002d);
}

.sb-icon {
  width: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(#ffffff, #e0e0e0);
}

.modaldiv{
    background-color: #d2cbcf71;
    border-radius: 10px;
}
.modaldiv input{
    background-color: transparent;
    border-top: none;
    border-right: none;
    border-left: none;
}
.modaldiv input:focus{
        background-color: transparent;
    border-top: none;
    border-right: none;
    border-left: none;
    
}

    #ChatMessages {
        scroll-behavior: smooth;
    }


</style>

<div class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- TAilwind comonent modal -->
    <!-- Main modal -->


    <div id="authentication-modal" data-modal-backdrop="static" data-modal-closable="false" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 flex justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full ">
        <div class="relative p-4 w-full max-w-md max-h-full ">
            <!-- Modal content -->
            <div class="relative border border-default border rounded-base shadow-sm p-4 md:p-6  modaldiv">
                <!-- Modal header -->
                <div class="flex items-center justify-between border-b border-default pb-4 md:pb-5">
                    <h3 class="text-lg font-medium text-heading">
                        Sign in to our platform
                    </h3>
                </div>
                <!-- Modal body -->
                <form action="#" class="pt-4 md:pt-6">
                    <div class="mb-4">
                        <input id="user" type="text" class="bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand block w-full px-3 py-2.5 shadow-xs placeholder:text-body" placeholder="Enter Your Name" required />
                    </div>
                    <button id="joinBtn" type="button" class="split-btn mb-3">
                        <div class="sb-text">Go to Chat</div>
                        <div class="sb-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff2e63" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                    </button>
                </form>
            </div>
        </div>
    </div>




    @* Modal End *@


    <div class="relative w-full max-w-md h-[850px] bg-gradient-to-b from-[#ff587e] via-[#ff8c61] to-[#ffc34d] shadow-2xl overflow-hidden sm:rounded-[3rem] border-8 border-white/20">

        <div class="px-6 pt-8 pb-4">
            <div class="flex items-center justify-between bg-white/30 backdrop-blur-sm rounded-full px-6 py-4 shadow-sm">
                <button class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>

                <h1 class="text-xl font-medium text-gray-900 tracking-wide fontwa">Chatrr</h1>

                <button class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center w-full px-0 mt-2">
            <div class="bg-white rounded-r-full pl-6 pr-8 py-2.5 shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                <span class="text-gray-800 font-medium text-sm">Group</span>
            </div>

            <div class="bg-white rounded-l-full pr-6 pl-8 py-2.5 shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                <span class="text-gray-800 font-medium text-sm">You</span>
            </div>
        </div>

        <div id="ChatMessages" class="flex flex-col gap-2 p-0 mt-12 overflow-y-auto h-[60%]">
            <div class="flex-1"></div>
        </div>


        <div class="absolute bottom-8 left-0 right-0 px-6">
            <div class="bg-white rounded-full p-2 shadow-lg flex items-center">
                <input id="msg" type="text"
                       placeholder="Type Here..."
                       class="flex-1 bg-transparent px-6 py-2 outline-none text-gray-600 placeholder-gray-400">
                <button id="btn" class="bg-[#2c2c2c] text-white p-3 rounded-full hover:bg-black transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z" />
                    </svg>
                </button>
            </div>
        </div>

    </div>







</div>


@* <input id="user" placeholder="Your name" /> *@
@* <button id="joinBtn">Join Chat</button> *@
@* <input id="msg" placeholder="Your name" /> *@
@* <button id="btn">Join Chat</button> *@
<br />
<br />
@* <ul id="messages"></ul>  *@
@* <input placeholder="Type here" /> *@
@* <button  disabled>Send</button> *@



<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js"></script>

<script>
    let loginModal;

        window.addEventListener("DOMContentLoaded", () => {
            const modalEl = document.getElementById("authentication-modal");

            const options = {
                backdrop: 'static',
                closable: false,
                onHide: () => {
                    console.log('modal is hidden');
                }
            };

            loginModal = new Modal(modalEl, options);
            loginModal.show();
        });
</script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>


<script>



    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chat")
        .withAutomaticReconnect()
        .build();


    let CurrentUser = "Guest";




    connection.on("UserJoined", (user) => {
        const chat = document.getElementById("ChatMessages");
        const div = document.createElement("div");

        div.className = "self-center text-xs text-green-600";
        div.textContent = `${user} joined the chat`;

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    });



 
        connection.on("ReceiveMessage", (user, message) => {

            var session = "AM";
            var Timestamp = "";

           
                var hour = new Date().getHours();
                var min = new Date().getMinutes();
                
                if (min < 10) min = "0" + min;


                if (hour >= 12) {
                    session = "PM";
                }
                if (hour == 0) {
                    hour = 12;
                }
                else if (hour > 12) {
                    hour = hour - 12;
                }
                    Timestamp = hour + ":" + min + " " + session;
            




        const chat = document.getElementById("ChatMessages");
        const wrapper = document.createElement("div");

        const isMe = user === CurrentUser;
    wrapper.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;

    wrapper.innerHTML = `
        <div class="
            bg-[#e0dfff] text-gray-800
            px-3 py-1.5 text-sm
            leading-tight
            max-w-[65%]
            break-words
            rounded-xl
            ${isMe ? 'rounded-l-2xl rounded-tr-md' : 'rounded-r-2xl rounded-tl-md'}
        ">
            ${message}
            <div class="text-[10px] text-gray-500 text-right mt-0">
                ${isMe ? "" : `[${user}]&nbsp;`}${Timestamp}
            </div>
        </div>
    `;


        chat.appendChild(wrapper);
        chat.scrollTop = chat.scrollHeight;
    });



connection.on("UserLeft", (user) => {
    const chat = document.getElementById("ChatMessages");
    const div = document.createElement("div");

    div.className = "self-center text-xs text-red-600";
    div.textContent = `${user} left the chat`;

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
});



    connection.start()
        .then(() => {
            console.log("Connected");

        })

        .catch(err => console.error(err));

        // Join button click
    document.getElementById("joinBtn").onclick = async () => {
            const user = document.getElementById("user").value.trim();

            if (!user) {
                Swal.fire({
                    icon: 'error',
                    title: 'Name Required',
                    text: 'Please enter your name to join the chat!',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#ff2e63', 
                    background: '#fff',
                    color: '#333',
                
                    backdrop: `
                        rgba(0,0,123,0.4)
                        left top
                        no-repeat
                    `
                });
                return;
            }

            CurrentUser = user;

            try {
                await connection.invoke("Join", user);

                document.getElementById("user").disabled = true;
                document.getElementById("joinBtn").disabled = true;
                document.getElementById("btn").disabled = false;

              
                loginModal.hide();

                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                });
                Toast.fire({
                    icon: 'success',
                    title: 'Welcome to Chatrr!'
                });

            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'Connection Error',
                    text: 'Could not connect to the chat server.',
                    confirmButtonColor: '#ff2e63'
                });
            }
        };


    document.getElementById("btn").onclick = sendMessage;

    const msgInput = document.getElementById("msg");
    msgInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

        async function sendMessage(){
        const user = document.getElementById("user").value.trim();
        const message = document.getElementById("msg").value.trim();

        if (!user || !message) return;

        if (connection.state === signalR.HubConnectionState.Connected) {

            await connection.invoke("SendMessage",user, message);
            document.getElementById("msg").value = "";
            document.getElementById("msg").focus();

        } else {
            console.log("Not connected");
        }
    }


        window.addEventListener("beforeunload", () => {
        const user = document.getElementById("user").value || "Guest";
        connection.invoke("Leave", user);
    });


</script>


